---
title: QC Troubleshooting Resource
layout: default
nav_order: 2
parent: Quality Control 
---

# Quality Control Workflow
{: .no_toc }

Internal resource for troubleshooting some of the most common issues encountered during our quality control process. The steps outlined below utilize a combination of open source and custom-built tools built in collaboration with and maintained by Media Preservation Services, Media Preservation Labs, and Digital Preservation. 

The workflows outlined on this page make use of the following NYPL GitHub repositories:

* [NYPL/ami-metadata](https://github.com/NYPL/ami-metadata)

* [NYPL/ami-preservation](https://github.com/NYPL/ami-preservation)

* [NYPL/ami-tools](https://github.com/NYPL/ami-tools)


**Note**: In most cases, you will be required to have full access to the drive/files you are working on to perform these repairs. 

While some errors may require a vendor or engineer to rework and re-deliver files, many of the most common errors encountered during QC can be fixed by using the steps outlined below. 

## Table of contents
{: .no_toc .text-delta }

1. TOC
{:toc}


## Repairable Errors

###  Invalid Oxum (Size Discrepancy)

[insert image]

The oxum of a bag may become invalid when the number of files listed in the manifest-md5.txt file do not correspond with the number of files present in the bag. Fixing an invalid oxum requires manually inspecting the manifest-md5.txt file against the number of items in the bag and using ```fix_baginfo.py``` and ```validate_ami_bags.py``` to fix and confirm validation of the bag.  

Repairing invalid oxum requires use of [NYPL/ami-tools](https://github.com/NYPL/ami-tools).

* Check the number of files in the manifest-md5 against the number of files present in each of the directories within the bag 
* Conform the manifest-md5.txt to match the files present in bag
* Delete tag manifest
* Repair bag using ```fix_baginfo.py```
* Validate bag
```
/path/to/ami-tools/bin/validate_ami_bags.py -b path/to/bag
```

###  Invalid JSON (Specifications Discrepancy)

[insert image]

A JSON file may be invalid when the contents or structure do not correspond to NYPL’s [AMI Digital Asset Specifications](https://nypl.github.io/ami-preservation/pages/ami-specifications.html). Some of the most common causes for invalid JSON include: empty required fields, use of terms not included in controlled vocabularies, inclusion of unrecognized characters, unnecessary blank spaces, and invalid JSON file structure. Repairing invalid JSON files requires using a combination of manual inspection and ```ajv validate```, ```fix_baginfo.py```, and ```validate_ami_bags.py``` to validate the file against a schema, fix the bag that contains the file, and confirm validation of the repaired bag. 

Repairing JSON requires use of [NYPL/ami-metadata](https://github.com/NYPL/ami-metadata).

* Determine the appropriate schema type based on the media format listed in the JSON
* Locate the sourceObjectFormat field in the JSON file
* Locate the format schema in ami-metadata that corresponds to the file you want to validate
* Validate the single JSON files against format schema
```
cd /path/to/ami-metadata/versions/2.0/schema
```
 ``` 
  ajv validate -s /path/to/version/2.0/schema/format schema -r path/to/versions/2.0/schema/fields.json -d /path/to/file you want to check
  ```
* Ajv will flag fields that don’t correspond to values defined by the format schema
* Compare errors to the schema to determine issue(s) 
* Manually repair errors and save file
* Run ajv against entire directory to confirm validation
``` 
ajv validate --all-errors --multiple-of-precision=2 --verbose -s /path/to/ami-metadata/versions/2.0/schema/digitized.json -r "/path/to/ami-metadata/versions/2.0/schema/*.json" -d "/Volumes/DRIVE-ID/*/*/data/*/*.json"
```
* If the JSON is located within a bag, fix bag info using ```fix_baginfo.py```
* Validate bag 
 ```
 validate_ami_bags.py -b path/to/bag 
 ```

###  Invisible Files

[insert image]

Another common issue that can occur during QC is the presence of invisible files. Invisible files are generated by an operating system—often during production or bagging—and because they are invisible, go unnoticed until the validation process. A bag containing invisible files will not validate due to a discrepancy between the number of files listed in the manifest-md5.txt file and the number of files present in the bag; this will often result in an invalid oxum. Invisible file filenames begin with a period and are easy to identify once the contents of a bag are listed in Terminal. 

```
cd path/to/directory 
```
* List contents of directory 

```
cd path/to/bag
```
```
ls -a
```
* Locate all invisible files

```
find . -name "*.file extension" | xargs grep "name of string"
```
* Remove invisible files

```
find ./ -name "filename" -exec rm {} ';'
```
* Run ```fix_baginfo.py``` to fix bag/directory 

* Validate directory/bag

```
Validate_ami_bags.py —-metadata –quiet -d path/to/directory
```


## Irrepairable Errors 

Media Preservation Services may not be able to repair some errors if the physical media requires re-digitization or the quantity of error(s) is substantial enough to justify re-work. In instances where it has been determined Media Preservation Services is unable to resolve an error, the vendor or the appropriate Media Preservation Labs Engineer is notified and re-work is requested. 

## Supplemental Resources

The following resources may be used in tandem with the steps outlined above to fix some common errors. 

###  Moving and Removing Files and Directories 

Occasionally during QC files and directories may need to be moved or removed for a variety of reasons, including: they fail quality control and need to be redelivery, or they pass and need to be moved to a new location. 

If vendor project files fail QC and need to be redelivered, the files are removed from the hard drive and quality control is completed on the remaining approved files. When the redelivered files are received, they must undergo the entire quality control process before they can be approved for ingest. 

When an in-house project passes QC, the project is moved from InHouse to the QC-pass_NotEavied directory on ICA. If an in-house project fails QC, the Media Preservation Labs Manage and Engineer is notified and the corrected files are redelivered to the InHouse directory on ICA. The reworked files are subject to the entire quality control process before they can be approved for ingest.  

* Move a file or directory from one location to another

```
mv /path/to/ directory path/to/new location
```
* Remove a file or directory using [Trash](https://hasseg.org/trash/). Trash will safely remove a file or directory and move it to your Trash 


###  Locate a string within a file type 

[insert image]

During QC it may be necessary to locate recurring file types, filenames, operators, or errors within a directory. 

Information about using grep can be found on the NYPL Media Preservation Documentation [Command Line Resources](https://nypl.github.io/ami-preservation/pages/resources.html#parsing-files-and-reports) page. 

* Navigate to the directory 

```
cd /path/to/directory
```

* Locate string within a directory

```
find . -name "*.file extension" | xargs grep "name of string"
```




## Tools
See our [Command Line Resources ](https://nypl.github.io/ami-preservation/pages/resources.html)for descriptions, usage, and installation instructions of various tools we use in this workflow.
